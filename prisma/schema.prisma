generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       String @id @default(nanoid())
  name     String
  email    String @unique
  password String

  // Один-к-одному: пользователь имеет одну подписку
  subscription   UserSubscription? @relation("UserToSubscription")
  subscriptionId String?           @unique

  // Один-ко-многим: пользователь имеет много транзакций
  transactions Transaction[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Plan {
  id           String   @id @default(nanoid())
  title        String
  description  String
  features     String[]
  monthlyPrice Int      @map("monthly_price")
  yearlyPrice  Int      @map("yearly_price")
  isFeatured   Boolean  @default(false) @map("is_featured")

  // Один-ко-многим: план имеет много подписок
  subscriptions UserSubscription[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("plans")
}

model UserSubscription {
  id     String             @id @default(nanoid())
  status SubscriptionStatus @default(PENDING_PAYMENT)

  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")

  // Многие-ко-одному: подписка принадлежит пользователю
  user   User   @relation("UserToSubscription", fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @map("user_id")

  // Многие-ко-одному: подписка на план
  plan   Plan   @relation(fields: [planId], references: [id], onDelete: Cascade)
  planId String @map("plan_id")

  // Один-ко-многим: подписка имеет много транзакций
  transactions Transaction[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_subscriptions")
}

model Transaction {
  id            String            @id @default(nanoid())
  amount        Int
  provider      PaymentProvider
  status        TransactionStatus @default(PENDING)
  externalId    String?           @map("external_id")
  providerMeta  Json              @map("provider_meta")
  billingPeriod BillingPeriod     @map("billing_period")

  // Многие-ко-одному: транзакция принадлежит пользователю
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @map("user_id")

  // Многие-ко-одному: транзакция принадлежит подписке (опционально)
  subscription   UserSubscription? @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  subscriptionId String?           @map("subscription_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("transactions")
}

enum SubscriptionStatus {
  PENDING_PAYMENT
  ACTIVE
  EXPIRED
}

enum PaymentProvider {
  YOOKASSA
  STRIPE
  CRYPTOPAY
}

enum TransactionStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
}

enum BillingPeriod {
  MONTHLY
  YEARLY
}
